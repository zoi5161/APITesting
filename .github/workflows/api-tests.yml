name: API Tests with Newman

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  newman-tests:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Docker
        uses: docker/setup-buildx-action@v2

      - name: Start containers
        run: docker compose up -d --build

      - name: Wait for Laravel API
        run: |
          echo "‚è≥ ƒê·ª£i Laravel API ch·∫°y l√™n..."
          for i in {1..30}; do
            if curl -s http://localhost:8091/api/status > /dev/null; then
              echo "‚úÖ Laravel API ƒë√£ s·∫µn s√†ng!"
              break
            fi
            echo "‚è≥ Ch·ªù th√™m 5s..."
            sleep 5
          done

      - name: Install PHP & Composer on runner
        run: |
          sudo apt-get update
          sudo apt-get install -y php-cli unzip curl
          curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer
          composer --version

      - name: Prepare Laravel environment
        run: |
          cp sprint5-with-bugs/API/.env.example sprint5-with-bugs/API/.env
          sed -i 's/DB_DATABASE=.*/DB_DATABASE=toolshop/' sprint5-with-bugs/API/.env
          sed -i 's/DB_USERNAME=.*/DB_USERNAME=user/' sprint5-with-bugs/API/.env
          sed -i 's/DB_PASSWORD=.*/DB_PASSWORD=root/' sprint5-with-bugs/API/.env
          sed -i 's/DB_HOST=.*/DB_HOST=mariadb/' sprint5-with-bugs/API/.env

      - name: Install PHP dependencies
        run: |
          cd sprint5-with-bugs/API
          sudo rm -rf vendor
          sudo mkdir -p vendor
          sudo chmod -R 777 vendor
          composer install --no-interaction --prefer-dist --optimize-autoloader

      - name: Fix permissions for Laravel storage
        run: |
          sudo chmod -R 777 sprint5-with-bugs/API/storage
          sudo chmod -R 777 sprint5-with-bugs/API/bootstrap/cache

      - name: Run migrations
        run: docker compose exec -T laravel-api php artisan migrate --force

      - name: Seed database
        run: docker compose exec -T laravel-api php artisan db:seed --force

      - name: Install Newman + Reporter
        run: |
          npm install -g newman
          npm install -g newman-reporter-htmlextra

      - name: Prepare reports folder
        run: mkdir -p reports

      - name: Normalize CSV line endings
        run: sed -i 's/\r$//' tests/*.csv

      - name: Run Brands API Tests
        run: |
          newman run tests/BrandsAPITests.json \
            --iteration-data tests/dataBrands.csv \
            -r cli \
            -r htmlextra --reporter-htmlextra-export reports/brands-report.html

      - name: Debug Products CSV (hexdump)
        run: |
          echo "üìÇ Hexdump of tests/dataProducts.csv:"
          hexdump -C tests/dataProducts.csv | head -n 50
          echo ""
          echo "üìÇ Preview CSV content:"
          cat -n tests/dataProducts.csv | head -n 20


      - name: Run Products API Tests
        run: |
              newman run tests/ProductsAPITests.json \
              --iteration-data tests/dataProducts.csv \
              -r cli \
              -r htmlextra --reporter-htmlextra-export reports/products-report.html

      # - name: Run Messages API Tests
      #   run: newman run tests/MessageAPITests.json \
      #         --env-var baseUrl="http://localhost:8091" \
      #         --iteration-data tests/dataMessages.csv \
      #         -r cli \
      #         -r htmlextra --reporter-htmlextra-export reports/messages-report.html

      - name: Upload Reports
        uses: actions/upload-artifact@v4
        with:
          name: newman-reports
          path: reports/*.html
