name: API Tests 🚀

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest

    services:
      docker:
        image: docker:24.0.6
        options: --privileged
        ports:
          - 8091:8091

    steps:
      - name: Checkout code 📥
        uses: actions/checkout@v4

      # Khởi động docker-compose
      - name: Start containers 🐳
        run: |
          export DISABLE_LOGGING=true
          docker compose -f docker-compose.yml up -d --build

      # Đợi DB & Laravel container lên
      - name: Wait for services ⏳
        run: sleep 40s

      # Copy file .env.ci (từ repo root) vào container Laravel
      - name: Copy env file into Laravel container ⚙️
        run: docker cp .env.ci $(docker compose ps -q laravel-api):/var/www/.env

      # Cài composer dependencies bên trong container Laravel
      - name: Install PHP dependencies 📦
        run: docker compose exec -T laravel-api composer install --no-interaction --prefer-dist

      # Generate APP_KEY cho Laravel
      - name: Generate Laravel key 🔑
        run: docker compose exec -T laravel-api php artisan key:generate

      # Chạy migrate + seed DB
      - name: Migrate & Seed database 🌱
        run: |
          docker compose exec -T laravel-api php artisan migrate:fresh --force
          docker compose exec -T laravel-api php artisan db:seed --force

      # Kiểm tra API status
      - name: Check API status
        run: curl -v http://localhost:8091/status || true

      # Cài Newman để chạy API tests
      - name: Install Newman 🧪
        run: npm install -g newman

      # Chạy API tests (sửa đường dẫn JSON & CSV theo repo của bạn)
      - name: Run Brands API tests
        run: newman run tests/BrandsAPITests.json --iteration-data data/dataBrands.csv

      - name: Run Products API tests
        run: newman run tests/ProductsAPITests.json --iteration-data data/dataProducts.csv

      - name: Run Messages API tests
        run: newman run tests/MessageAPITests.json --iteration-data data/dataMessages.csv
