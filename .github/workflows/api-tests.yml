name: API Tests with Newman

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  newman-tests:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Docker
        uses: docker/setup-buildx-action@v2

      - name: Start containers
        run: docker-compose up -d

      - name: Wait for Laravel API
        run: |
          echo "⏳ Đợi Laravel API chạy lên..."
          for i in {1..30}; do
            if curl -s http://localhost:8091/ > /dev/null; then
              echo "✅ Laravel API đã sẵn sàng!"
              break
            fi
            echo "⏳ Chờ thêm 5s..."
            sleep 5
          done

      - name: Run migrations
        run: docker-compose exec -T laravel-api php artisan migrate

      - name: Seed database
        run: docker-compose exec -T laravel-api php artisan db:seed

      - name: Install Newman
        run: npm install -g newman

      - name: Run Brands API Tests
        run: newman run tests/postman/BrandsAPITests.json --iteration-data tests/postman/dataBrands.csv

      - name: Run Products API Tests
        run: newman run tests/postman/ProductsAPITests.json --iteration-data tests/postman/dataProducts.csv

      - name: Run Messages API Tests
        run: newman run tests/postman/MessageAPITests.json --iteration-data tests/postman/dataMessages.csv
