name: API Tests ğŸš€

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest

    services:
      docker:
        image: docker:24.0.6
        options: --privileged
        ports:
          - 8091:8091

    steps:
      - name: Checkout code ğŸ“¥
        uses: actions/checkout@v4

      # Khá»Ÿi Ä‘á»™ng docker-compose
      - name: Start containers ğŸ³
        run: |
          export DISABLE_LOGGING=true
          docker compose -f docker-compose.yml up -d --build

      # Äá»£i DB & Laravel container lÃªn
      - name: Wait for services â³
        run: sleep 40s

      # Copy file .env.ci (tá»« repo root) vÃ o container Laravel
      - name: Copy env file into Laravel container âš™ï¸
        run: docker cp .env.ci $(docker compose ps -q laravel-api):/var/www/.env

      # CÃ i composer dependencies bÃªn trong container Laravel
      - name: Install PHP dependencies ğŸ“¦
        run: docker compose exec -T laravel-api composer install --no-interaction --prefer-dist

      # Generate APP_KEY cho Laravel
      - name: Generate Laravel key ğŸ”‘
        run: docker compose exec -T laravel-api php artisan key:generate

      # Cháº¡y migrate + seed DB
      - name: Migrate & Seed database ğŸŒ±
        run: |
          docker compose exec -T laravel-api php artisan migrate:fresh --force
          docker compose exec -T laravel-api php artisan db:seed --force

      # Kiá»ƒm tra API status
      - name: Check API status
        run: curl -v http://localhost:8091/status || true

      # CÃ i Newman Ä‘á»ƒ cháº¡y API tests
      - name: Install Newman ğŸ§ª
        run: npm install -g newman

      # Cháº¡y API tests (sá»­a Ä‘Æ°á»ng dáº«n JSON & CSV theo repo cá»§a báº¡n)
      - name: Run Brands API tests
        run: newman run tests/BrandsAPITests.json --iteration-data data/dataBrands.csv

      - name: Run Products API tests
        run: newman run tests/ProductsAPITests.json --iteration-data data/dataProducts.csv

      - name: Run Messages API tests
        run: newman run tests/MessageAPITests.json --iteration-data data/dataMessages.csv
