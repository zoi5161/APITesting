name: API Tests with Newman

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  newman-tests:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Docker
        uses: docker/setup-buildx-action@v2

      - name: Start containers
        run: docker compose up -d --build

      - name: Wait for Laravel API
        run: |
          echo "⏳ Đợi Laravel API chạy lên..."
          for i in {1..30}; do
            if curl -s http://localhost:8091/ > /dev/null; then
              echo "✅ Laravel API đã sẵn sàng!"
              break
            fi
            echo "⏳ Chờ thêm 5s..."
            sleep 5
          done

      - name: Install PHP & Composer on runner
        run: |
          sudo apt-get update
          sudo apt-get install -y php-cli unzip curl
          curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer
          composer --version

      - name: Prepare Laravel environment
        run: |
          cp sprint5-with-bugs/API/.env.example sprint5-with-bugs/API/.env
          sed -i 's/DB_DATABASE=.*/DB_DATABASE=toolshop/' sprint5-with-bugs/API/.env
          sed -i 's/DB_USERNAME=.*/DB_USERNAME=user/' sprint5-with-bugs/API/.env
          sed -i 's/DB_PASSWORD=.*/DB_PASSWORD=root/' sprint5-with-bugs/API/.env
          sed -i 's/DB_HOST=.*/DB_HOST=mariadb/' sprint5-with-bugs/API/.env

      - name: Install PHP dependencies
        run: |
          cd sprint5-with-bugs/API
          sudo rm -rf vendor
          sudo mkdir -p vendor
          sudo chmod -R 777 vendor
          composer install --no-interaction --prefer-dist --optimize-autoloader

      - name: Fix permissions for Laravel storage
        run: docker compose exec -T laravel-api chmod -R 777 storage bootstrap/cache

      - name: Run migrations
        run: docker compose exec -T laravel-api php artisan migrate --force

      - name: Seed database
        run: docker compose exec -T laravel-api php artisan db:seed --force

      - name: Install Newman + Reporter
        run: |
          npm install -g newman
          npm install -g newman-reporter-htmlextra

      - name: Run Brands API Tests
        run: newman run tests/postman/BrandsAPITests.json \
              --iteration-data tests/postman/dataBrands.csv \
              -r htmlextra --reporter-htmlextra-export reports/brands-report.html

      - name: Run Products API Tests
        run: newman run tests/postman/ProductsAPITests.json \
              --iteration-data tests/postman/dataProducts.csv \
              -r htmlextra --reporter-htmlextra-export reports/products-report.html

      - name: Run Messages API Tests
        run: newman run tests/postman/MessageAPITests.json \
              --iteration-data tests/postman/dataMessages.csv \
              -r htmlextra --reporter-htmlextra-export reports/messages-report.html

      - name: Upload Reports
        uses: actions/upload-artifact@v4
        with:
          name: newman-reports
          path: reports/*.html
